'use strict';var m=this;
function v(g,n,p){function x(a){return a&&"object"===typeof a&&"default"in a?a:{"default":a}}n=x(n);p=x(p);const q=new n["default"];n=Object.freeze({__proto__:null,G:q});let f;class A{constructor(a,b){this.id=q.next();this.isSystem=!0;this.name="";this.disabled=!1;this.loopTimes=0;this.entitySet=new WeakMap;this.usedBy=[];this.name=a;this.B=b}query(a){return this.B(a)}checkUpdatedEntities(a){a&&(f=this.entitySet.get(a),f||(f=new Set,this.entitySet.set(a,f)),a.updatedEntities.forEach(b=>{this.query(b)?
f.add(b):f.delete(b)}));return this}A(a){a&&((f=this.entitySet.get(a))?f.clear():(f=new Set,this.entitySet.set(a,f)),a.elements.forEach(b=>{this.query(b)?f.add(b):f.delete(b)}))}run(a,b){b.H=a;a.entityManager&&this.entitySet.get(a.entityManager)?.forEach(e=>{this.handle(e,b)});return this}}class y{constructor(a,b){this.isComponent=!0;this.data=null;this.disabled=!1;this.usedBy=[];this.name=a;this.data=b}clone(){return new y(this.name,this.data)}}let h;var r;(function(a){a.ADD_COMPONENT="addComponent";
a.REMOVE_COMPONENT="removeComponent"})(r||(r={}));class c{constructor(){this.elements=new Map;this.disabled=!1;this.usedBy=[];this.isComponentManager=!0}add(a){this.has(a)&&this.removeByInstance(a);return this.addComponentDirect(a)}addComponentDirect(a){this.elements.set(a.name,a);a.usedBy.push(this);c.g={o:a,m:this,i:c.j,u:Infinity,target:a};this.l(c.j,c.g);return this}clear(){this.elements.clear();return this}get(a){return(h=this.elements.get(a))?h:null}has(a){return"string"===typeof a?this.elements.has(a):
this.elements.has(a.name)}isMixedFrom(a){console.log(a);return!1}mixFrom(a){console.log(a);return this}remove(a){return"string"===typeof a?this.removeByName(a):this.removeByInstance(a)}removeByName(a){if(h=this.elements.get(a))this.elements.delete(a),h.usedBy.splice(h.usedBy.indexOf(this),1),c.g={o:h,m:this,i:c.h,u:Infinity,target:h},this.l(c.h,c.g);return this}removeByInstance(a){this.elements.has(a.name)&&(this.elements.delete(a.name),a.usedBy.splice(a.usedBy.indexOf(this),1),c.g={o:a,m:this,i:c.h,
u:Infinity,target:a},this.l(c.h,c.g));return this}l(a,b){for(let e of this.usedBy){e.dispatchEvent(a,b);for(let B of e.usedBy)B.updatedEntities.add(e)}}}c.j=r.j;c.h=r.h;c.g={};let w;class C extends p["default"]{constructor(a,b){super();this.id=q.next();this.isEntity=!0;this.name="";this.usedBy=[];this.name=a;this.registerComponentManager(b)}addComponent(a){if(this.componentManager)this.componentManager.add(a);else throw Error("Current entity hasn't registered a component manager yet.");return this}addTo(a){a.add(this);
return this}addToWorld(a){a.entityManager&&a.entityManager.add(this);return this}getComponent(a){return this.componentManager?this.componentManager.get(a):null}hasComponent(a){return this.componentManager?this.componentManager.has(a):!1}registerComponentManager(a=new c){this.unregisterComponentManager();this.componentManager=a;this.componentManager.usedBy.includes(this)||this.componentManager.usedBy.push(this);return this}removeComponent(a){this.componentManager&&this.componentManager.remove(a);return this}unregisterComponentManager(){this.componentManager&&
(w=this.componentManager.usedBy,w.splice(w.indexOf(this)-1,1),this.componentManager=null);return this}}let t;class z{constructor(a){this.elements=new Map;this.data=null;this.disabled=!1;this.updatedEntities=new Set;this.isEntityManager=!0;this.usedBy=[];a&&this.usedBy.push(a)}add(a){this.has(a)&&this.removeByInstance(a);return this.addComponentDirect(a)}addComponentDirect(a){this.elements.set(a.name,a);a.usedBy.push(this);this.updatedEntities.add(a);return this}clear(){this.elements.clear();return this}get(a){return(t=
this.elements.get(a))?t:null}has(a){return"string"===typeof a?this.elements.has(a):this.elements.has(a.name)}remove(a){return"string"===typeof a?this.removeByName(a):this.removeByInstance(a)}removeByName(a){if(t=this.elements.get(a))this.elements.delete(a),this.s(t);return this}removeByInstance(a){this.elements.has(a.name)&&(this.elements.delete(a.name),this.s(a));return this}s(a){a.usedBy.splice(a.usedBy.indexOf(this),1);for(let b of this.usedBy)b.systemManager&&b.systemManager.elements.forEach(e=>
{e.entitySet.get(this)&&e.entitySet.get(this).delete(a)})}}let k;var u;(function(a){a.BEFORE_RUN="beforeRun";a.AFTER_RUN="afterRun"})(u||(u={}));class d extends p["default"]{constructor(a){super();this.disabled=!1;this.elements=new Map;this.loopTimes=0;this.usedBy=[];a&&this.usedBy.push(a)}add(a){if(this.elements.has(a.name))return this;this.elements.set(a.name,a);this.C(a);return this}clear(){this.elements.clear();return this}get(a){return(k=this.elements.get(a))?k:null}has(a){return"string"===typeof a?
this.elements.has(a):this.elements.has(a.name)}remove(a){return"string"===typeof a?this.removeByName(a):this.removeByInstance(a)}removeByName(a){if(k=this.elements.get(a))this.elements.delete(a),this.v(k),k.usedBy.splice(k.usedBy.indexOf(this),1);return this}removeByInstance(a){this.elements.has(a.name)&&(this.elements.delete(a.name),this.v(a),a.usedBy.splice(a.usedBy.indexOf(this),1));return this}v(a){for(let b of this.usedBy)b.entityManager&&a.entitySet.delete(b.entityManager)}C(a){for(let b of this.usedBy)b.entityManager&&
a.A(b.entityManager)}run(a,b){d.g.i=d.BEFORE_RUN;d.g.m=this;this.dispatchEvent(d.BEFORE_RUN,d.g);this.elements.forEach(e=>{e.checkUpdatedEntities(a.entityManager);e.run(a,b)});a.entityManager&&a.entityManager.updatedEntities.clear();this.loopTimes++;d.g.i=d.AFTER_RUN;this.dispatchEvent(d.BEFORE_RUN,d.g);return this}}d.AFTER_RUN=u.AFTER_RUN;d.BEFORE_RUN=u.BEFORE_RUN;d.g={};let l;class D{constructor(a,b,e){this.id=q.next();this.isWorld=!0;this.name=a;this.registerEntityManager(b);this.registerSystemManager(e)}add(a){return a.isEntity?
this.addEntity(a):this.addSystem(a)}addEntity(a){if(this.entityManager)this.entityManager.add(a);else throw Error("The world doesn't have an entityManager yet.");return this}addSystem(a){if(this.systemManager)this.systemManager.add(a);else throw Error("The world doesn't have a systemManager yet.");return this}hasEntity(a){return this.entityManager?this.entityManager.has(a):!1}hasSystem(a){return this.systemManager?this.systemManager.has(a):!1}registerEntityManager(a){this.unregisterEntityManager();
this.entityManager=a||new z(this);this.entityManager.usedBy.includes(this)||this.entityManager.usedBy.push(this);return this}registerSystemManager(a){this.unregisterSystemManager();this.systemManager=a||new d(this);this.systemManager.usedBy.includes(this)||this.systemManager.usedBy.push(this);return this}remove(a){return a.isEntity?this.removeEntity(a):this.removeSystem(a)}removeEntity(a){this.entityManager&&this.entityManager.remove(a);return this}removeSystem(a){this.systemManager&&this.systemManager.remove(a);
return this}run(a){this.systemManager&&this.systemManager.run(this,a);return this}unregisterEntityManager(){this.entityManager&&(l=this.entityManager.usedBy,l.splice(l.indexOf(this)-1,1),this.entityManager=null);return this}unregisterSystemManager(){this.systemManager&&(l=this.systemManager.usedBy,l.splice(l.indexOf(this)-1,1),this.entityManager=null);return this}}g.AbstructSystem=A;g.Component=y;g.ComponentManager=c;g.Entity=C;g.D=z;g.F=n;g.SystemManager=d;g.World=D;Object.defineProperty(g,"__esModule",
{value:!0})}"object"===typeof exports&&"undefined"!==typeof module?v(exports,require("@valeera/idgenerator"),require("@valeera/eventdispatcher")):"function"===typeof define&&define.amd?define(["exports","@valeera/idgenerator","@valeera/eventdispatcher"],v):(m="undefined"!==typeof globalThis?globalThis:m||self,v(m.X={},m.IdGenerator,m.EventDispatcher));
